
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Three things I love about CircleCI &#8212; blog  documentation</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.e00ebc5fe59cde01733db895d987848c.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.88dc4f4c5bd3676d55da.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
  
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  
  <link rel="alternate" type="application/atom+xml"  href="../../../blog/atom.xml" title="Predictably Noisy">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../../../">
      <img src="../../../_static/logo.png" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../about/">About me</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../projects/">Projects</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../publications/">Publications</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../blog/">Blog</a>
        </li>
        
        
      </ul>


      <form class="bd-search d-flex align-items-center" action="../../../search/" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this site..." aria-label="Search this site..." autocomplete="off" >
</form>
      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/choldgraf/" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/choldgraf" target="_blank" rel="noopener">
              <span><i class="fab fa-twitter-square"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">
  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    29 January 2019
  
  </h2>

  <ul>
    

  

  

  

  
  <li id="category"><span><i class="fa-fw fa fa-folder-open"></i></span>
    
      
      <a href="../../../blog/category/coding/">coding</a>
      
    </li>
  

  
  <li id="tags"><span><i class="fa-fw fa fa-tags"></i>
      </span>
    
      
      <a href="../../../blog/tag/ci/">CI</a>
      
    
      
      <a href="../../../blog/tag/cd/">CD</a>
      
    
      
      <a href="../../../blog/tag/continuous-integration/">continuous integration</a>
      
    
      
      <a href="../../../blog/tag/dev-ops/">dev ops</a>
      
    
      
      <a href="../../../blog/tag/software-development/">software development</a>
      
    </li>
  
  
  </ul>

  <h3><a href="../../../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../../2020/2020-01-22-rst-thoughts/">22 January - What do people think about rST?</a></li>
    
      <li><a href="../2019-10-27-jupyter-governance-python/">27 October - What would Python-style governance look like in Jupyter?</a></li>
    
      <li><a href="../2019-10-22-xarray-neuro/">22 October - Analyzing intracranial electrophysiology data with xarray</a></li>
    
      <li><a href="../2019-10-13-rust-jupyter-governance/">13 October - What would Rust-style governance look like in Jupyter?</a></li>
    
      <li><a href="../2019-10-11-automating-jb/">11 October - Automating Jupyter Book deployments with CI/CD</a></li>
    
  </ul>

  <h3><a href="../../../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../../blog/2020/">2020 (1)</a></li>
    
  
    
    <li><a href="../../../blog/2019/">2019 (7)</a></li>
    
  
  </ul>

          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#re-run-a-job-with-ssh-access" class="nav-link">Re-run a job with SSH access</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#persisting-files-between-jobs-with-workspaces" class="nav-link">Persisting files between jobs with Workspaces</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#re-use-code-snippets-with-commands" class="nav-link">Re-use code snippets with Commands</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="three-things-i-love-about-circleci">
<h1>Three things I love about CircleCI<a class="headerlink" href="#three-things-i-love-about-circleci" title="Permalink to this headline">¶</a></h1>
<p>I recently had to beef up the continuous deployment of Jupyter Book, and used
it as an opportunity to learn a bit more about CircleCI’s features. It turns out,
they’re pretty cool! Here are a few of the things that I learned this time around.</p>
<p>For those who aren’t familiar with CircleCI, it is a service that runs Continuous
Integration and Continuous Deployment (CI/CD) workflows for projects. This basically
means that they manage many kinds of infrastructure that can launch jobs that run
test suites, deploy applications, and test on many different environments.</p>
<p>Here are some cool things that I now have a much better appreciation for:</p>
<div class="section" id="re-run-a-job-with-ssh-access">
<h2>Re-run a job with SSH access<a class="headerlink" href="#re-run-a-job-with-ssh-access" title="Permalink to this headline">¶</a></h2>
<p>Often when tests don’t pass or a build otherwise fails, it’s really helpful to be
able to get into the machine itself and just start poking around. It turns out that
CircleCI makes this really easy! If a build has failed, then you can use the drop-down
menu next to the “Restart Job” button to select “Restart Job with SSH”. The next time
the job fails (which it probably will, since you’ve just restarted a job that already
failed once), CircleCI will print the IP address and SSH command to connect to that
machine remotely.</p>
</div>
<div class="section" id="persisting-files-between-jobs-with-workspaces">
<h2>Persisting files between jobs with Workspaces<a class="headerlink" href="#persisting-files-between-jobs-with-workspaces" title="Permalink to this headline">¶</a></h2>
<p>Everything CircleCI does is based around containers - each job has a Docker image
environment specified (and CircleCI curates a large list of containers for testing).
One challenge this introduces is that it can be more complex to use jobs that have
<em>multiple</em> languages or tools installed. You can always manually configure this, but
I’ve found that another easy solution is to split your task across multiple jobs,
and persist some of the files between them with CircleCI workspaces.</p>
<p>To set up a CircleCI workspace, you first need two jobs, then</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">build_files</span><span class="p">:</span>
    <span class="nt">docker</span><span class="p">:</span>
      <span class="c1"># We use a Python image to test our files and run the test suite</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/python:3.6-stretch</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="c1"># Some steps to build files we need in another job</span>
      <span class="c1"># Assume it places the built files into a folder called `_build/`</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build_stuff_with_python</span>

      <span class="c1"># Persist the specified paths (see https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs)</span>
      <span class="p p-Indicator">-</span> <span class="nt">persist_to_workspace</span><span class="p">:</span>
          <span class="c1"># The root of the workspace, here just the CWD</span>
          <span class="nt">root</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
          <span class="c1"># The sub-paths of the workspace to persist</span>
          <span class="nt">paths</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_build/</span>

  <span class="nt">deploy_files</span><span class="p">:</span>
    <span class="nt">docker</span><span class="p">:</span>
      <span class="c1"># We&#39;ll use a Ruby image to deploy our files</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">circleci/ruby:2.6</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="c1"># Connect the files from the last job to this job</span>
      <span class="p p-Indicator">-</span> <span class="nt">attach_workspace</span><span class="p">:</span>
          <span class="c1"># Must be absolute path or relative path from working_directory</span>
          <span class="nt">at</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/workspace</span>

      <span class="c1"># Our final deployment steps</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy_files_with_ruby</span>
</pre></div>
</div>
<p>Finally, we’ll set up a CircleCI workflow that runs the deployment job only after the
build job as finished, since the deploy job depends on files that are created by the
build job.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">workflows</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">default</span><span class="p">:</span>
    <span class="nt">jobs</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build_files</span>
      <span class="c1">#</span>
      <span class="p p-Indicator">-</span> <span class="nt">deploy_files</span><span class="p">:</span>
          <span class="nt">requires</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build_files</span>
</pre></div>
</div>
<p>In this way, we’ve split our task (build a bunch of files, then deploy them online)
into two different jobs. One that builds files with a Python container, and another that
deploys them with a Ruby container.</p>
</div>
<div class="section" id="re-use-code-snippets-with-commands">
<h2>Re-use code snippets with Commands<a class="headerlink" href="#re-use-code-snippets-with-commands" title="Permalink to this headline">¶</a></h2>
<p>Finally, many times you’d like to re-use the same set of snippets across multiple
points of your CircleCI jobs. In 2.1, CircleCI added a new feature called Commands
that does this fairly simply. Commands are kind of like functions in that they
wrap up a collection of steps that can be re-used and parameterized. This means you
can define a “template” of a collection of steps, then fill-in missing fields in that
template in order to modify its behavior.</p>
<p>For example, here’s a Command template to build a site with Jekyll:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">commands</span><span class="p">:</span>
  <span class="nt">build_site</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;Build</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Jekyll&quot;</span>
    <span class="nt">parameters</span><span class="p">:</span>
      <span class="c1"># We&#39;ll define one parameter that lets us pass build arguments to Jekyll build</span>
      <span class="nt">build_args</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
        <span class="nt">default</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">run</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build the website</span>
          <span class="c1"># Note the &lt;&lt; parameters.param &gt;&gt; syntax that lets you define your own inputs</span>
          <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bundle exec jekyll build &lt;&lt; parameters.build_args &gt;&gt;</span>
</pre></div>
</div>
<p>Now, we can re-use this command throughout our build steps. Here are two jobs that use
this command in different ways:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">jobs</span><span class="p">:</span>
  <span class="c1"># Build the site to store artifacts</span>
  <span class="nt">build_with_params</span><span class="p">:</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="c1"># Build the site&#39;s HTML w/ the base_url for CircleCI artifacts</span>
      <span class="p p-Indicator">-</span> <span class="nt">build_site</span><span class="p">:</span>
          <span class="nt">build_args</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">--baseurl /0/html/</span>
  <span class="c1"># Build the site to store artifacts</span>
  <span class="nt">build_without_params</span><span class="p">:</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="c1"># Build the site&#39;s HTML w/ defaults for Jekyll</span>
      <span class="p p-Indicator">-</span> <span class="nt">build_site</span><span class="p">:</span>
          <span class="nt">build_args</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
<p>Each of these jobs uses the command specified above in <code class="docutils literal notranslate"><span class="pre">build_site</span></code>, but
they use the <code class="docutils literal notranslate"><span class="pre">build_args</span></code> parameter to modify its behavior each time.</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../2019-03-16-jupyter-dev/">
    Thoughts from the Jupyter team meeting 2019
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  
  </span>
</div>

  
  
  </div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../../_static/js/index.88dc4f4c5bd3676d55da.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-88310237-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020, Chris Holdgraf.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>